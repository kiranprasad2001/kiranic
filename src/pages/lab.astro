---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import ProjectCard from '../components/ProjectCard.astro';

const title = "Lab";

// GitHub Data Fetching
const GITHUB_USERNAME = "kiranprasad2001";
const GITHUB_TOKEN = import.meta.env.GITHUB_PAT || process.env.GITHUB_PAT;

interface Repo {
    name: string;
    description: string;
    html_url: string;
    homepage: string;
    topics: string[];
    language: string;
    pushed_at: string;
    archived: boolean;
    readmeContent?: string;
}

// Fallback data in case API fails
const FALLBACK_EXPERIMENTS = [
    {
        title: "SaaS ECM Tool (Agentic Workflow)",
        description: "Experimental Enterprise Content Management tool powered by agentic AI workflows to semantic search and organize documents.",
        tags: ["AI", "ECM", "Python", "LLMs"],
        link: "https://kiran-ccm-tool.kiranic.com",
        year: "In Progress"
    },
    {
        title: "TTC Super Tracker",
        description: "Real-time transit tracking app for the Greater Toronto Area. Aggregates data from multiple agencies into a unified, interactive map interface.",
        tags: ["Transit API", "React", "Real-time", "Leaflet"],
        link: "https://ttc.kiranic.com",
        year: "2024"
    },
    {
        title: "Shashi",
        description: "Personal experimental project for tracking my kids progress",
        tags: ["Experimental", "Web"],
        link: "https://shashi.kiranic.com",
        year: "2024"
    },
    {
        title: "Local LLM Experiments",
        description: "Researching fine-tuning and deployment optimizations for running open-weights LLMs on consumer hardware for privacy-focused tasks.",
        tags: ["LLM", "Fine-tuning", "Privacy", "Local Inference"],
        year: "Ongoing"
    },
    {
        title: "Resume",
        description: "A modern, accessible, and performant web application built with Ruby theme. Features dynamic routing, clean architecture, and Cloudflare deployment.",
        tags: ["Ruby", "Cloudflare"],
        link: "https://resume.kiranic.com",
        year: "2024"
    }
];

// Helper: Clean Markdown to get a summary
function extractSummary(markdown: string): string | null {
    if (!markdown) return null;
    
    // Remove badges/images
    let text = markdown.replace(/\[!\[.*?\]\(.*?\)\]\(.*?\)/g, '')
                       .replace(/!\[.*?\]\(.*?\)/g, '');
    
    // Remove headers
    text = text.replace(/^#+\s+.*$/gm, '');
    
    // Remove HTML tags
    text = text.replace(/<[^>]*>/g, '');
    
    // Find first meaningful paragraph
    const paragraphs = text.split(/\n\n+/);
    for (const p of paragraphs) {
        const cleanP = p.replace(/\r/g, '').trim();
        if (cleanP.length > 20 && !cleanP.startsWith('[')) { 
             // Strip links [text](url) -> text
             return cleanP.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1').slice(0, 160) + (cleanP.length > 160 ? '...' : '');
        }
    }
    return null;
}

let experiments = [];

try {
    if (GITHUB_TOKEN) {
        const query = `
        query {
            user(login: "${GITHUB_USERNAME}") {
                repositories(first: 100, orderBy: {field: PUSHED_AT, direction: DESC}, privacy: PUBLIC, isFork: false) {
                    nodes {
                        name
                        description
                        url
                        homepageUrl
                        pushedAt
                        isArchived
                        languages(first: 1) { nodes { name } }
                        repositoryTopics(first: 5) { nodes { topic { name } } }
                        readme: object(expression: "HEAD:README.md") {
                            ... on Blob { text }
                        }
                    }
                }
            }
        }`;

        const response = await fetch('https://api.github.com/graphql', {
            method: 'POST',
            headers: {
                'Authorization': `bearer ${GITHUB_TOKEN}`,
                'Content-Type': 'application/json',
                'User-Agent': 'Kiranic-Portfolio'
            },
            body: JSON.stringify({ query })
        });

        if (!response.ok) throw new Error(`GitHub GraphQL Error: ${response.statusText}`);
        const { data } = await response.json();
        
        experiments = data.user.repositories.nodes
            .filter((repo: any) => !repo.isArchived)
            .map((repo: any) => {
                const readmeSummary = repo.readme ? extractSummary(repo.readme.text) : null;
                const lastActive = new Date(repo.pushedAt);
                const now = new Date();
                const monthsSinceActive = (now.getFullYear() - lastActive.getFullYear()) * 12 + (now.getMonth() - lastActive.getMonth());
                const year = monthsSinceActive < 6 ? "In Progress" : lastActive.getFullYear().toString();
                
                const tags = repo.repositoryTopics.nodes.map((t: any) => t.topic.name);
                const mainLang = repo.languages.nodes[0]?.name;
                if (mainLang && !tags.includes(mainLang)) tags.unshift(mainLang);

                return {
                    title: repo.name.replace(/-/g, ' ').replace(/\b\w/g, (l:string) => l.toUpperCase()),
                    description: readmeSummary || repo.description || "No description provided.",
                    tags: tags.slice(0, 4),
                    link: repo.homepageUrl || repo.url,
                    year: year
                };
            });

    } else {
        const response = await fetch(`https://api.github.com/users/${GITHUB_USERNAME}/repos?sort=pushed&per_page=100&type=owner`, { 
            headers: { 'User-Agent': 'Kiranic-Portfolio' } 
        });
        
        if (!response.ok) throw new Error(`GitHub REST API Error: ${response.statusText}`);
        const repos = await response.json();
        
        experiments = repos.filter((r: any) => !r.archived).map((repo: any) => {
            const lastActive = new Date(repo.pushed_at);
            const now = new Date();
            const year = ((now.getFullYear() - lastActive.getFullYear()) * 12 + (now.getMonth() - lastActive.getMonth())) < 6 ? "In Progress" : lastActive.getFullYear().toString();
            
            const tags = repo.topics || [];
            if (repo.language && !tags.includes(repo.language)) tags.unshift(repo.language);

            return {
                title: repo.name.replace(/-/g, ' ').replace(/\b\w/g, (l:string) => l.toUpperCase()),
                description: repo.description || "No description provided.",
                tags: tags.slice(0, 4),
                link: repo.homepage || repo.html_url,
                year: year
            };
        });
    }

} catch (error) {
    console.error("Failed to fetch GitHub repos:", error);
    experiments = FALLBACK_EXPERIMENTS;
}
---

<BaseLayout title={title}>
    <Navbar />
    
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 w-full">
        <div class="mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white mb-4">The Lab</h1>
            <p class="text-slate-600 dark:text-slate-300 max-w-2xl">
                My playground for side projects, research, and experiments.
            </p>
        </div>

        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {experiments.map(item => (
                <ProjectCard {...item} />
            ))}
        </div>
    </main>

    <Footer />
</BaseLayout>
