---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import ProjectCard from '../components/ProjectCard.astro';

const title = "Lab";

// GitHub Data Fetching
const GITHUB_USERNAME = "kiranprasad2001";
const GITHUB_TOKEN = import.meta.env.GITHUB_PAT || process.env.GITHUB_PAT;

interface Repo {
    name: string;
    description: string;
    html_url: string;
    homepage: string;
    topics: string[];
    language: string;
    pushed_at: string;
    archived: boolean;
}

// Fallback data in case API fails
const FALLBACK_EXPERIMENTS = [
    {
        title: "SaaS ECM Tool (Agentic Workflow)",
        description: "Experimental Enterprise Content Management tool powered by agentic AI workflows to semantic search and organize documents.",
        tags: ["AI", "ECM", "Python", "LLMs"],
        link: "https://kiran-ccm-tool.kiranic.com",
        year: "In Progress"
    },
    {
        title: "TTC Super Tracker",
        description: "Real-time transit tracking app for the Greater Toronto Area. Aggregates data from multiple agencies into a unified, interactive map interface.",
        tags: ["Transit API", "React", "Real-time", "Leaflet"],
        link: "https://ttc.kiranic.com",
        year: "2024"
    },
    {
        title: "Shashi",
        description: "Personal experimental project for tracking my kids progress",
        tags: ["Experimental", "Web"],
        link: "https://shashi.kiranic.com",
        year: "2024"
    },
    {
        title: "Local LLM Experiments",
        description: "Researching fine-tuning and deployment optimizations for running open-weights LLMs on consumer hardware for privacy-focused tasks.",
        tags: ["LLM", "Fine-tuning", "Privacy", "Local Inference"],
        year: "Ongoing"
    },
    {
        title: "Resume",
        description: "A modern, accessible, and performant web application built with Ruby theme. Features dynamic routing, clean architecture, and Cloudflare deployment.",
        tags: ["Ruby", "Cloudflare"],
        link: "https://resume.kiranic.com",
        year: "2024"
    }
];

let experiments = [];

try {
    const headers: Record<string, string> = {
        "User-Agent": "Kiranic-Portfolio",
        "Accept": "application/vnd.github.v3+json"
    };

    if (GITHUB_TOKEN) {
        headers["Authorization"] = `token ${GITHUB_TOKEN}`;
    }

    const response = await fetch(`https://api.github.com/users/${GITHUB_USERNAME}/repos?sort=pushed&per_page=100&type=owner`, { headers });
    
    if (!response.ok) {
        throw new Error(`GitHub API Error: ${response.statusText}`);
    }

    const repos: Repo[] = await response.json();

    experiments = repos
        .filter(repo => !repo.archived) // Optional: Hide archived?
        .map(repo => {
            const lastActive = new Date(repo.pushed_at);
            const now = new Date();
            const monthsSinceActive = (now.getFullYear() - lastActive.getFullYear()) * 12 + (now.getMonth() - lastActive.getMonth());
            
            // Status Logic
            const year = monthsSinceActive < 6 ? "In Progress" : lastActive.getFullYear().toString();

            // Tags Logic
            const tags = repo.topics || [];
            if (repo.language && !tags.includes(repo.language)) {
                tags.unshift(repo.language);
            }

            return {
                title: repo.name.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), // Title Case
                description: repo.description || "No description provided.",
                tags: tags.slice(0, 4), // Limit tags
                link: repo.homepage || repo.html_url,
                year: year
            };
        });

} catch (error) {
    console.error("Failed to fetch GitHub repos:", error);
    experiments = FALLBACK_EXPERIMENTS;
}
---

<BaseLayout title={title}>
    <Navbar />
    
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 w-full">
        <div class="mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white mb-4">The Lab</h1>
            <p class="text-slate-600 dark:text-slate-300 max-w-2xl">
                My playground for side projects, research, and experiments.
            </p>
        </div>

        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {experiments.map(item => (
                <ProjectCard {...item} />
            ))}
        </div>
    </main>

    <Footer />
</BaseLayout>
